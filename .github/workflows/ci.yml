name: EEG-RAG Continuous Integration

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run nightly tests at 2 AM UTC
    - cron: "0 2 * * *"

jobs:
  # Code Quality and Style Checks
  code-quality:
    name: Code Quality & Style
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 mypy
          pip install -r requirements-dev.txt

      - name: Check code formatting with Black
        run: black --check --diff src/ tests/

      - name: Check import sorting with isort
        run: isort --check-only --diff src/ tests/

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Check for style issues (warnings only)
          flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics

      - name: Type checking with mypy
        run: |
          mypy src/eeg_rag --ignore-missing-imports --strict-optional
        continue-on-error: true # Don't fail CI for type issues yet

  # Security Scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: "pip"

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety pip-audit

      - name: Run Bandit security scanner
        run: |
          bandit -r src/ -f json -o bandit-report.json
          bandit -r src/ -f txt
        continue-on-error: true

      - name: Check for known vulnerabilities with Safety
        run: |
          safety check --json --output safety-report.json
          safety check
        continue-on-error: true

      - name: Audit pip packages
        run: |
          pip-audit --format=json --output=pip-audit-report.json
          pip-audit
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
            pip-audit-report.json

  # Unit and Integration Tests
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-psutil

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install pytest pytest-cov pytest-asyncio pytest-xdist

      - name: Create test environment
        run: |
          mkdir -p data/embeddings/cache
          mkdir -p logs

      - name: Run unit tests
        run: |
          pytest tests/ -v \
            --cov=eeg_rag \
            --cov-report=term \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov \
            --junitxml=test-results.xml \
            --maxfail=5 \
            -x

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            test-results.xml
            coverage.xml
            htmlcov/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: matrix.python-version == '3.9'
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # Performance and Resilience Tests
  resilience-tests:
    name: System Resilience Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [code-quality]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          sudo apt-get update
          sudo apt-get install -y python3-psutil
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run resilience tests
        run: |
          pytest tests/test_system_resilience.py -v \
            --tb=short \
            --maxfail=3

      - name: Run boundary condition tests
        run: |
          pytest tests/test_*_boundary_conditions.py -v \
            --tb=short \
            --maxfail=5

      - name: Run performance benchmarks
        run: |
          pytest tests/test_system_resilience.py::TestPerformanceBenchmarks -v -s \
            --tb=short
        continue-on-error: true # Performance tests are informational

  # Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [test]
    if: github.event_name == 'push' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          sudo apt-get update
          sudo apt-get install -y python3-psutil
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Set up test environment
        run: |
          mkdir -p data/{raw,processed,embeddings}
          mkdir -p logs
          echo "TESTING=true" >> $GITHUB_ENV

      - name: Run integration tests
        run: |
          pytest tests/integration/ -v \
            --tb=short \
            --maxfail=3 \
            --timeout=120
        continue-on-error: true # Integration tests may depend on external services

  # Documentation Build
  docs:
    name: Documentation Build
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install sphinx sphinx-rtd-theme myst-parser

      - name: Check documentation links
        run: |
          # Check for broken internal links
          find docs/ -name "*.md" -exec grep -l "](.*\.md)" {} \; | while read file; do
            echo "Checking links in $file"
            grep -oP '\[.*?\]\(\K[^)]*(?=\))' "$file" | while read link; do
              if [[ "$link" =~ ^[^#]*\.md ]] && [[ ! -f "docs/$link" ]]; then
                echo "Broken link in $file: $link"
                exit 1
              fi
            done
          done

      - name: Validate documentation format
        run: |
          # Check that all documentation files are properly formatted
          for file in docs/*.md; do
            if [ -f "$file" ]; then
              echo "Validating $file"
              # Check for required sections
              if ! grep -q "^# " "$file"; then
                echo "Missing main heading in $file"
                exit 1
              fi
            fi
          done

  # Dependency Audit
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
          pip install -r requirements.txt

      - name: Audit dependencies for vulnerabilities
        run: |
          pip-audit --format=json --output=audit-results.json
          pip-audit --format=table
        continue-on-error: true

      - name: Check for outdated dependencies
        run: |
          pip list --outdated --format=json > outdated-packages.json
          pip list --outdated
        continue-on-error: true

      - name: Upload dependency reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: dependency-reports
          path: |
            audit-results.json
            outdated-packages.json

  # Deployment Readiness Check
  deployment-check:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [code-quality, test, security]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check package build
        run: |
          python -m build --sdist --wheel
          ls -la dist/

      - name: Validate package metadata
        run: |
          pip install twine
          twine check dist/*

      - name: Test package installation
        run: |
          pip install dist/*.whl
          python -c "import eeg_rag; print('Package installed successfully')"

      - name: Generate deployment artifacts
        run: |
          echo "BUILD_VERSION=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
          echo "GIT_SHA=${GITHUB_SHA:0:8}" >> $GITHUB_ENV

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v3
        with:
          name: deployment-artifacts
          path: |
            dist/
            requirements.txt
            docker/

  # Notification of results
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs:
      [code-quality, security, test, resilience-tests, docs, dependency-audit]
    if: always()

    steps:
      - name: Check overall status
        run: |
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Resilience: ${{ needs.resilience-tests.result }}"
          echo "Docs: ${{ needs.docs.result }}"
          echo "Dependencies: ${{ needs.dependency-audit.result }}"

          # Determine overall status
          if [[ "${{ needs.code-quality.result }}" == "failure" || "${{ needs.test.result }}" == "failure" ]]; then
            echo "CI_STATUS=FAILED" >> $GITHUB_ENV
          elif [[ "${{ needs.security.result }}" == "failure" || "${{ needs.docs.result }}" == "failure" ]]; then
            echo "CI_STATUS=WARNINGS" >> $GITHUB_ENV  
          else
            echo "CI_STATUS=PASSED" >> $GITHUB_ENV
          fi

      - name: Create status badge
        run: |
          mkdir -p badges
          case "$CI_STATUS" in
            "PASSED")
              echo "![CI Status](https://img.shields.io/badge/CI-PASSED-brightgreen)" > badges/ci-status.md
              ;;
            "WARNINGS") 
              echo "![CI Status](https://img.shields.io/badge/CI-WARNINGS-yellow)" > badges/ci-status.md
              ;;
            "FAILED")
              echo "![CI Status](https://img.shields.io/badge/CI-FAILED-red)" > badges/ci-status.md
              ;;
          esac

      - name: Upload status badge
        uses: actions/upload-artifact@v3
        with:
          name: ci-status-badge
          path: badges/
